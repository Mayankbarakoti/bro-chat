<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bro-Chat ðŸ’€ - Live Chat</title>
  <style>
    /* Basic clean styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      color: #eee;
      margin: 0; padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    header {
      background: #111;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    #chatWindow {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-top: 2px solid #00bcd4;
      border-bottom: 2px solid #00bcd4;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      max-width: 80%;
    }
    .message.sent {
      flex-direction: row-reverse;
      margin-left: auto;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 10px;
      object-fit: cover;
      border: 2px solid #00bcd4;
    }
    .message-content {
      background: rgba(0, 188, 212, 0.3);
      padding: 10px 15px;
      border-radius: 15px;
      position: relative;
      color: #fff;
      word-wrap: break-word;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .message.sent .message-content {
      background: rgba(76, 175, 80, 0.7);
    }
    .name {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #a0e7ff;
    }
    .message-info {
      font-size: 0.7rem;
      text-align: right;
      margin-top: 3px;
      color: #ccc;
    }
    form {
      display: flex;
      padding: 1rem;
      background: #111;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.7);
    }
    #messageInput {
      flex: 1;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border-radius: 30px;
      border: none;
      outline: none;
      margin-right: 10px;
    }
    button {
      background: #00bcd4;
      border: none;
      color: white;
      padding: 0 20px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #0097a7;
    }
    #actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 0.5rem 0 1rem 0;
      background: #111;
    }
    #actions button {
      flex: none;
      width: 120px;
    }
    /* Scrollbar styling */
    #chatWindow::-webkit-scrollbar {
      width: 8px;
    }
    #chatWindow::-webkit-scrollbar-track {
      background: transparent;
    }
    #chatWindow::-webkit-scrollbar-thumb {
      background: #00bcd4;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <header>Bro-Chat ðŸ’€ - Live Stranger Chat</header>

  <div id="chatWindow" aria-live="polite" aria-label="Chat messages">
    <!-- Messages will appear here -->
  </div>

  <form id="messageForm" autocomplete="off" aria-label="Send message form">
    <input
      id="messageInput"
      type="text"
      placeholder="Type your message..."
      aria-required="true"
      aria-label="Message input"
      autocomplete="off"
    />
    <button type="submit" aria-label="Send message">Send</button>
  </form>

  <div id="actions">
    <button id="newChatBtn" aria-label="Start a new chat">New Chat</button>
    <button id="leaveChatBtn" aria-label="Leave chat">Leave Chat</button>
  </div>

  <script>
    // Load profile from localStorage
    const profileData = JSON.parse(localStorage.getItem('brochatProfile'));
    if (!profileData) {
      alert('Profile not found. Redirecting to profile setup.');
      window.location.href = 'profile.html';
    }

    const chatWindow = document.getElementById('chatWindow');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const leaveChatBtn = document.getElementById('leaveChatBtn');
    const newChatBtn = document.getElementById('newChatBtn');

    // Message statuses
    const STATUS = {
      SENT: 'sent',
      DELIVERED: 'delivered',
      READ: 'read'
    };

    let socket;
    let connected = false;
    let messages = [];

    // Create a chat message element
    function createMessageElement(message) {
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(message.sender === 'me' ? 'sent' : 'received');

      // Avatar
      const avatar = document.createElement('img');
      avatar.classList.add('avatar');
      avatar.src = message.sender === 'me' ? profileData.avatar : (message.avatar || 'https://i.ibb.co/8g5j2Nm/flash.png');
      avatar.alt = message.sender === 'me' ? profileData.nickname : (message.name || 'Stranger');
      div.appendChild(avatar);

      // Content container
      const content = document.createElement('div');
      content.classList.add('message-content');

      // Name
      const nameEl = document.createElement('div');
      nameEl.classList.add('name');
      nameEl.textContent = message.sender === 'me' ? profileData.nickname : (message.name || 'Stranger');
      content.appendChild(nameEl);

      // Text
      const textEl = document.createElement('div');
      textEl.textContent = message.text;
      content.appendChild(textEl);

      // Message info - ticks for sent messages
      const info = document.createElement('div');
      info.classList.add('message-info');

      if (message.sender === 'me') {
        // Simple tick icon
        const tickIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        tickIcon.setAttribute('class', 'ticks');
        tickIcon.setAttribute('viewBox', '0 0 24 24');
        tickIcon.setAttribute('aria-hidden', 'true');
        tickIcon.style.width = '16px';
        tickIcon.style.height = '16px';
        tickIcon.innerHTML = `<path d="M1.5 12l5 5L21 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`;

        if (message.status === STATUS.SENT) {
          tickIcon.style.color = 'white';
        } else if (message.status === STATUS.DELIVERED) {
          tickIcon.style.color = '#00bcd4';
        } else if (message.status === STATUS.READ) {
          tickIcon.style.color = '#4caf50';
        }
        info.appendChild(tickIcon);
      }

      content.appendChild(info);
      div.appendChild(content);

      return div;
    }

    // Append message to chat window
    function appendMessage(message) {
      const msgEl = createMessageElement(message);
      chatWindow.appendChild(msgEl);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Connect to WebSocket server
    function connectSocket() {
      socket = new WebSocket('ws://localhost:3000'); // Change to your backend address if needed

      socket.addEventListener('open', () => {
        console.log('Connected to chat server');
        connected = true;

        // Send join message with profile info for matchmaking
        socket.send(JSON.stringify({
          type: 'join',
          nickname: profileData.nickname,
          avatar: profileData.avatar
        }));

        // Inform user
        appendMessage({
          sender: 'other',
          text: 'Searching for a stranger to chat with...',
          status: STATUS.READ,
          avatar: '',
          name: 'System'
        });
      });

      socket.addEventListener('message', event => {
        const data = JSON.parse(event.data);

        if (data.type === 'message') {
          // Incoming message from stranger
          const incomingMsg = {
            sender: 'other',
            text: data.text,
            status: STATUS.READ,
            avatar: data.avatar,
            name: data.nickname
          };
          messages.push(incomingMsg);
          appendMessage(incomingMsg);

          // Optionally, send read receipt
          socket.send(JSON.stringify({ type: 'read_receipt', messageId: data.messageId || null }));
        } 
        else if (data.type === 'system') {
          // System notifications
          if (data.event === 'partner_connected') {
            appendMessage({
              sender: 'other',
              text: 'Stranger connected! Say hi ðŸ‘‹',
              status: STATUS.READ,
              avatar: '',
              name: 'System'
            });
          } 
          else if (data.event === 'partner_disconnected') {
            appendMessage({
              sender: 'other',
              text: 'Stranger disconnected.',
              status: STATUS.READ,
              avatar: '',
              name: 'System'
            });
          }
          else if(data.event === 'no_partner_found'){
            appendMessage({
              sender: 'other',
              text: 'No stranger found currently. Please try again.',
              status: STATUS.READ,
              avatar: '',
              name: 'System'
            });
          }
        } 
        else if (data.type === 'status_update') {
          // Update message status if needed
        }
      });

      socket.addEventListener('close', () => {
        console.log('Disconnected from chat server');
        connected = false;
        appendMessage({
          sender: 'other',
          text: 'Disconnected from chat server.',
          status: STATUS.READ,
          avatar: '',
          name: 'System'
        });
      });

      socket.addEventListener('error', (err) => {
        console.error('WebSocket error:', err);
        alert('Connection error. Please reload the page.');
      });
    }

    // Send chat message
    function sendMessage(text) {
      if (!connected) {
        alert('Not connected to the server.');
        return;
      }

      // Prepare message to send
      const msgObj = {
        type: 'message',
        text: text,
        nickname: profileData.nickname,
        avatar: profileData.avatar
      };

      socket.send(JSON.stringify(msgObj));

      // Append locally with SENT status
      const localMsg = {
        sender: 'me',
        text,
        status: STATUS.SENT
      };
      messages.push(localMsg);
      appendMessage(localMsg);
    }

    // Leave chat
    function leaveChat() {
      if (connected && socket) {
        socket.close();
      }
      window.location.href = 'profile.html';
    }

    // Start new chat
    function newChat() {
      if (connected && socket) {
        socket.send(JSON.stringify({ type: 'new_chat' }));
      }
      messages = [];
      chatWindow.innerHTML = '';
      appendMessage({
        sender: 'other',
        text: 'Searching for a new stranger...',
        status: STATUS.READ,
        avatar: '',
        name: 'System'
      });
    }

    // Init on page load
    connectSocket();

    // Form submission - send message
    messageForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      sendMessage(text);
      messageInput.value = '';
      messageInput.focus();
    });

    // Leave chat button
    leaveChatBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to leave the chat?')) {
        leaveChat();
      }
    });

    // New chat button
    newChatBtn.addEventListener('click', () => {
      if (confirm('Start a new chat? Current messages will be cleared.')) {
        newChat();
      }
    });

    // ESC key to leave chat
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        leaveChatBtn.click();
      }
    });
  </script>
</body>
</html>
